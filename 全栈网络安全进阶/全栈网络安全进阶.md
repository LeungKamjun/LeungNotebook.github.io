# 必修一、红队渗透测试与ATT&CK框架入门

## 红队渗透测试漏洞术语

### 漏洞利用

#### 漏洞

 **Vulnerability 漏洞**：是指计算机软件、硬件、系统、应用、协议等反面的缺陷，使其保密性、完整性、可用性、访问控制等方面面临威胁

基于**技术**分类有：命令执行、权限绕过、缓冲区溢出、注入、解析、弱口令、信息泄露等

基于**时间**分类有：0 day（刚刚发现漏洞，厂商还未修复）、1 day（厂商刚修复的漏洞）、N day（） 等

#### CVE

**CVE(Common Vulnerabilities & Exposures)**： 通用漏洞和暴露，通过CNA机构分类漏洞编号，通过CVSS系统评估漏洞等级

#### PoC

**PoC(Proof of Concept)** 概念验证，对一段漏洞验证程序或攻击阳历，仅能验证漏洞存在，不能对漏洞尽心实际性利用

#### Exp

**Exploit** 漏洞利用，目的是获取未经授权的方位或执行意外操作等，平台：metasploit、Exploit DATABASE、CIA Hacking Tools Revealed

#### Payload

攻击载荷，攻击者在目标机器上执行的定制代码或程序，包括但不限于系统命令、会话建立、Shellcode

#### Shellcode

用于获取控制权或操作界面的攻击载荷代码，通常采用二进制机器代码

正反shell：shell需要捆绑到指定IP地址和端口号上，这个动作就是bindshell；由攻击方主动连接到受害者，则为正向shell；由受害者主动连接攻击方，则为反向shell

### 恶意程序

#### Malware

Malware 恶意程序或软件，泛指病毒、蠕虫、木马、勒索软件、间谍软件等。用于对目标系统尽心入侵、控制、窃取、破坏等行动

#### **Virus 病毒**

病毒，通产依附在其他文件或程序上，不进行自我复制传播，当受害者运行其他程序时则病毒启动、对目标系统造成破坏

#### Worm 蠕虫病毒

能独立于其他文件或程序运行，能基于网络进行自我复制和传播，能实现从点到面超大规模的破坏行为

#### Trojan Horse

特洛伊木马，通常潜伏于“合法”软件中运行（也可独立运行），不复制传播且高度隐蔽。木马在运行时能创建“后门”或者“隧道”，攻击者通过后门实现对目标系统的远程控制、监听、破坏等行为

#### Romsomware

勒索软件，能独立于其他文件或程序运行，能基于网络进行自我复制和传播，通过对目标系统的加密和劫持，实现对受害者的钱财勒索

#### Spyware

间谍软件（流氓软件或恶意软件），值未经用户许可搜集用户个人信息的恶意程序。通过搜集网站浏览记录、键盘记录、账号密码等隐私信息、再以网页劫持、网址导航、弹框广告等方式变现盈利

#### Rootkits

可看成升级型的木马病毒，泛指能获取到 root 权限的恶意程序，包括系统内核rookit、内存rookit、应用程序rookit等类型

### 攻击方法

#### APT攻击

APT(Advanced Persistent Threat) 高级持续性威胁，针对特定目标进行的手段高超、低调隐蔽、时间持久、精心策划的攻击

#### 零日攻击

利用 0 day 漏洞发起的“核武器级”攻击，除非攻击目标存在超高价值，否则 0 day 不会轻易使用；相比之下，1/Nday 结合水坑或鱼塘攻击性价比更高

### 钓鱼攻击

攻击者改用社会工程学的方法，伪装成可信任的人或机构，通过高仿网站、欺诈邮件、虚假短信等方式，印有受害者“上钩”，根据不同实施方式，可细分为鱼叉攻击、鲸钓攻击、水坑攻击等方法

#### 鱼叉钓鱼

通常采用定制化电子邮件等方式，针对个人、组织、政府等进行定向攻击，是当前APT或红队主要的“投毒”并获取入口的主要方式、

#### 鲸钓攻击

针对核心人员或组织等进行鱼叉式攻击

#### 水坑攻击

攻击者分析目标人员或组织的日常上网规律，提前入侵网站并植入恶意程序

## 红队渗透测试方法论

- 渗透测试执行标准 **PTES**
  - ![image-20230707174006049](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230707174006049.png)
- 网络杀伤链 **CKC(THE CYBER KILL CHAIN)**
  - ![image-20230707174153866](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230707174153866.png)
- **MITRE ATT&CK** 框架
  - ![image-20230708163654104](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230708163654104.png)
  - ![image-20230707174438932](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230707174438932.png) 
  - ATT&CK框架可以看成是在Cyber Kill Chain网络杀伤链的基础上，提供了更细粒度、更易共享的战术、技术、文档、工具等资源。
  - ATT&CK框架分为PRE-ATT&CK、ATT&CK for Enterprise、ATT&CK for Mobile三大部分，我们学习和讨论，一般重点关注ATT&CK for Enterprise。
  - 二维矩阵图
    - ![image-20230707175407263](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230707175407263.png)
    - ATT&CK for Enterprise横轴表示战术（现在有14个），纵轴表示技术（177项技术348项子技术)，按照标准的TTPs来进行描述，能用于红蓝对抗、威胁情报分析、安全差距评估等。
    - ATT&CK for Enterprise包括初始访问、执行、持久化、权限提升、防御绕过、凭证访问、发现、横向移动、搜集、命令与控制、数据获取、影响14个战术。


## ATT&CK红蓝对抗框架

### 矩阵战术技术

> ATT&CK for Enterprise横轴表示战术（现在有14个），纵轴表示技术（177项技术348项子技术)
>
> ![image-20230708162934856](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230708162934856.png)

#### 矩阵图

链接： [矩阵 - 企业 |米特雷·阿特克® (mitre.org)](https://attack.mitre.org/matrices/enterprise/#)

#### ATT&CK战术

> 作战行动不要求使用所有战术，战术也没有先后顺序，战术的数量和顺序由使用者自行决定

![image-20230708163654104](%E5%85%A8%E6%A0%88%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6image/image-20230708163654104.png)

# 必修二、信息搜集原理与实践

## 1、概述

### 1.1 信息收集类型

- 主动信息收集
  - 与目标产生交互，对目标产生一定影响或有可能暴露自己
- 被动信息收集
  - 不与目标产生教育，通过第三方获取目标信息

### 1.2 信息收集的三个阶段

1. 目标资产枚举
   1. 用于列出能直接接触或简单分析就能获得的资产信息
   2. 例如：IP地址、域名
2. 资产属性关联
   1. 通过分析资产清单后，得出与某一个资产信息关联的其他资产信息
   2. 例如：域名的子域名
3. 资产攻击面分析
   1. 将资产信息和安全问题关联后得出的威胁清单，一般对应的时威胁建模阶段

### 1.3 信息收集的作用

- 了解目标自身
- 明确攻击范围
- 方便威胁建模

### 1.4 目标资产

- IP地址
- 域名子域名
- 目标app资产
- 基础设备信息：路由器、交换机、防火墙、蜜罐等等
- 通信基础架构
- 云基础架构
- 电子邮件：社会工程学攻击
- 网站内容
- 目标基础信息
- 目标员工信息
- 互联网归档信息
- 目标社交账号信息
- 对外服务

## 2、IP信息搜集

### 2.1 IP地址可以进行收集的信息

- 端口扫描
- 隐藏接口
- 运维自带后门
- 已知常见后面
- c 段
- 旁注

### 2.2 端口扫描

- **描述**
  - 端口扫描可以用来发现主机开放的端口
- **利用场景**
  - 用于目标信息收集阶段，若判定目标防御手段薄弱，并且想要快速找到脆弱点，端口扫描就是最好的方法
- **相关工具**
  - nmap
  - 自定义的python脚本
  - masscan
  - 在线端口扫描网站

### 2.3 隐藏接口

- **描述**
  - 不具备显式域名，直接使用ip+port或者路径访问的接口。通常是开发者预留的用于测试的、不稳定或者未完成的接口
- **利用场景**
  - 内部测试接口
  - 合作方调用的接口
  - 反射调用接口
- **相关工具**
  - burpsuite

### 2.4 运维自带后门

- **描述**
  - 运维为了方便离线工作，会在服务器上留一些用于远程控制的工具或者运维账号
- **利用场景**
  - 在获取内部VPN的情况下，若存在此后门，可以方便的入侵到内网环境中
- **相关工具**
  - nmap

### 2.5 已知常见后门

- **描述**
  - 网站后门，如webshell
- **利用场景**
  - 在入侵服务器之前，可能该服务器已经被其他黑客种马了，可以通过扫描常见的webshell来尝试连接
- **相关工具**
  - 菜刀、weevely、msf、蚁剑等后门链接

### 2.6  c 段

- **描述**
  - 同网段不同服务器
- **利用场景**
  - 当目标网站找不到漏洞，但是该网站所在的服务器集群中，其他服务器有漏洞，那么可以拿下其他服务器后，再进行横向渗透
- **相关工具**
  - c 段扫描工具
  - 自定义python脚本
  - nmap

### 2.7 旁注

- **描述**
  - 同服务器不同站点
- **利用场景**
  - 当目标网站没有弱点，但是该网站所在的服务器中部署多个站点，而其他站点有漏洞，此时可以通过旁注技术来入侵其他站点，继而打到攻陷目标站点的目的
- **相关工具**
  - whois

## 3、域名与子域名信息收集

### 3.1 通用技巧

- Googlehacking
  - baidu、duck
- shodanhacking
  - fofa等网络空间测绘工具
- 威胁分析平台
  - 腾讯哈勃
  - 奇安信 alpha
  - 微步在线
  - virustotal
  - virscan

### 3.2 敏感域名

- 测试页面
- 内部管理页面
- 违规开放的域名

### 3.3 其他

- **端口扫描**
- **敏感目录**
- **操作系统类型和版本**
- **Web 应用服务器类型及版本**
  - nginx
  - apache
  - iis
  - weblogic
  - jboss
- **Web** **应用框架**
  - struts2
  - spring
  - Django
  - flask
  - thinkphp
  - express
- **cms**
  - wordpress
  - dedecms
  - metinfo
  - ecshop
  - 友邻 b2b
  - edusoho 网校

## 4、其他信息收集

### 4.1 目标app资产

- 业务有关app
- 员工内部app
- 测试版app

### 4.2 基础设备信息

- 防火墙
- 路由交换设备
- Web应用防火墙
- 负载均衡设备
- 静态资源服务器
- 蜜罐
- MySQL等数据服务器

### 4.3 通信基础架构

- 网络边界设备
  - vpn、邮箱等各类网关
- 使用过的运营商
- cdn
- dns

### 4.4 云基础架构

- 云服务器厂商信息
- docker 与服务器识别

### 4.5 网站内容

- 网站性质
- 网站业务

### 4.6 目标基础信息

- 域名备案

### 4.7 员工信息

- 目标社交账号小号
- 目标网盘信息
- 目标工号
- 目标vpn信息

### 4.8 互联网归档信息

- 网页快照
- 网盘泄露

### 4.9 目标社交账户信息

- 公众号
- 知乎、b站等账号

### 4.10 对外服务

- 公司对外业务
- 第三方合作账号

## 5、Google Hacking

### 5.1 字符

- `' (空格)' 、'+(加号)' ` 可以用作关键字拼接

- `'|(管道符)'` 用于区分关键字，搜索结果会是其中一个关键字

  - ```
    荔枝|番茄|冬瓜  # 搜索结果是这三个中的其中一个
    ```

- `-(减号)` 类似于编程中的非运算，搜索结果会排除出该关键字

  - ```
    心灵奇旅 - 香港 #
    ```

  - 
